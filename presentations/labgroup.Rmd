---
title: "Using Cultural Consensus Theory to Predict Violenct Outbursts in Forensic Psychiatric Hospitals"
author: "Don van den Bergh"
date: '2022-03-28'
output: 
  ioslides_presentation: 
    widescreen: yes
    smaller: yes
    transition: faster
runtime: shiny
revealjs::revealjs_presentation:
  theme: night
  center: true
width: 1920
height: 1080
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = "~/storage/github/MesdagProject")
library(shiny)
library(CCTLogistic)
library(ggplot2)
library(patchwork)
library(dplyr)
library(DT)
library(tibble)
library(rlang)

options(DT.options = list(
  scrollX     = TRUE,
  scrollY     = 450,
  deferRender = TRUE,
  scroller    = TRUE,
  dom         = "tpri"
))

```

```{r read data}

wide_data     <- read_wide_data()
long_data     <- read_long_data()
violence_data <- read_violence_data()

```

## Outline

-   The Data

-   A CCT Model

-   Predictive Performance

## Mesdag Data

-   104 patients, 23 items, 188 raters
-   patients are divided into 8 crime groups with 6 disorders
-   raters are subdivided into 4 groups
-   IFBE was administered at 2 time points

In addition, we know a patients age (grouped by 10 years) and treatment duration

In total, there are 798 item scores, but only 104 violent outcomes.

## Raw Data

```{r raw data, echo = FALSE, warning=FALSE}
# datatable(wide_data, rownames = FALSE)
datatable(wide_data, extensions = c("Scroller", "RowGroup", "FixedColumns"), 
          options = list(rowGroup = list(dataSrc = 1), fixedColumns = list(leftColumns = 2)))
```

## Aggregated Data

```{r aggregated data, echo = FALSE, warning=FALSE}
datatable(violence_data, extensions = "Scroller")
```

## Descriptives

```{r descriptives plot, echo = FALSE, fig.height=10, fig.width=10, fig.align='center', warning=FALSE}
load_figure_obj("descriptives_combined_plt.rds")
```

## The Basic CCT Model

<!-- ![Image Title](/home/dvdb/storage/github/MesdagProject/graphicalmodels/split/graphicalmodels_7.pdf){width=65%} -->

<!-- <object data="/home/dvdb/storage/github/MesdagProject/graphicalmodels/split/graphicalmodels_7.pdf" type="application/pdf" width="700px" height="700px"> -->

<!--     <embed src="/home/dvdb/storage/github/MesdagProject/graphicalmodels/split/graphicalmodels_7.pdf"> -->

<!--         <p>This browser does not support PDFs. Please download the PDF to view it: <a href="/home/dvdb/storage/github/MesdagProject/graphicalmodels/split/graphicalmodels_7.pdf">Download PDF</a>.</p> -->

<!--     </embed> -->

<!-- </object> -->

```{r graphical model 1, echo = FALSE}
knitr::include_graphics("/home/dvdb/storage/github/MesdagProject/graphicalmodels/split/graphicalmodels_7.pdf")
```

## Predicting violence

```{r graphical model 2, echo = FALSE}
knitr::include_graphics("graphicalmodels/split/graphicalmodels_9.pdf")
```

----

```{r shiny one patient, echo=FALSE}
# renderSVG <- function(expr, width = 8, height = 3.75, ...) {
#   file <- htmltools::capturePlot(
#     expr, tempfile(fileext = ".svg"),
#     grDevices::svg,
#     width = width, height, ...
#   )
#   renderImage(list(src = file), deleteFile = TRUE)
# }

fallback_thresholds <- function(thresholds, nc, mustwork = FALSE) {
  
  if (identical(thresholds, "random")) {
    thresholds <- sort(rnorm(nc - 1))
  } else if (identical(thresholds, "uniform") || mustwork) {
    thresholds <- (1:(nc - 1))
    thresholds <- log(thresholds / (nc - thresholds))
  }
  return(thresholds)
}


shinyApp(
  # ui = sidebarLayout(
  #   sidebarPanel = sidebarPanel(
  #     sidebarPanel(
  #       sliderInput("nc",     label = "No. outcome categories:",       value = 5, min =  2,   max = 30, step = 1  ),
  #       sliderInput("lt",     label = "Latent truth:",                 value = 0, min = -3,   max =  3, step = 0.1),
  #       sliderInput("lambda", label = "Item difficulty:",              value = 1, min =  0.1, max =  3, step = 0.1),
  #       sliderInput("E",      label = "Rater accuracy:",               value = 1, min =  0.1, max =  3, step = 0.1),
  #       textInput("thresholds", "Thresholds:", value = "uniform"),
  #       numericInput("seed", "Seed:", value = 42)
  #     )
  #   ),
  #   mainPanel = mainPanel(imageOutput("modelPlot", width = "100%", height = "400px"))
  # ),
  ui = fluidPage(
    tags$head(
          tags$style(
            HTML('
              #nc{height: 30px}
              #lt{height: 30px}
              #lambda{height: 20px}
              #E{height: 10px}
            ')
          )
        ),
    column(width = 4, inputPanel(
      sliderInput("nc",     label = "No. outcome categories:",       value = 5, min =  2,   max = 30, step = 1  ),
      sliderInput("lt",     label = "Latent truth:",                 value = 0, min = -3,   max =  3, step = 0.1),
      sliderInput("lambda", label = "Item difficulty:",              value = 1, min =  0.1, max =  3, step = 0.1),
      sliderInput("E",      label = "Rater accuracy:",               value = 1, min =  0.1, max =  3, step = 0.1),
      textInput("thresholds", "Thresholds:", value = "uniform"),
      numericInput("seed", "Seed:", value = 42)
    )),
    column(width = 8, imageOutput("modelPlot", width = "100%", height = "400px"))
  ),
  server = function(input, output) {
    output$modelPlot <- renderImage(deleteFile = TRUE, expr = {
      # renderPlot({
      # renderSVG({
      
      # input <- list(
      #   nc         = 5,
      #   thresholds = "uniform",
      #   lt         = 0,
      #   lambda     = 1,
      #   E          = 1
      # )

      nc         <- input$nc
      thresholds <- trimws(input$thresholds)
      lt         <- input$lt
      log_lambda <- log(input$lambda)
      log_E      <- log(input$E)
      set.seed(input$seed)

      thresholds <- fallback_thresholds(thresholds, nc)
      if (is.character(thresholds)) {

        thresholds <- gsub(",", " ", thresholds, fixed = TRUE)
        temp <- strsplit(thresholds, "\\s+")[[1L]]
        thresholds <- suppressWarnings(as.numeric(temp))
        
        if (anyNA(thresholds) || length(thresholds) != (nc - 1))
          thresholds <- fallback_thresholds("uniform", nc)

      }

      dat <- simulate_data_ltm(
        np = 1, ni = 1, nr = 1, no_rater_groups = 1,
        nc = nc, lt = matrix(lt, 1, 1), log_lambda = matrix(log_lambda, 1, 1),
        log_E = log_E, thresholds = matrix(thresholds, 1, nc - 1),
        threshold_type = "free", store_probabilities = TRUE
      )
      
      df_prob <- tibble(
        outcome     = factor(seq_len(nc)),
        probability = c(dat$parameters$probabilities)
      )
      g1 <- ggplot(data = df_prob, aes(x = outcome, y = probability, fill = outcome)) +
        geom_col(col = "black") +
        scale_y_continuous(breaks = seq(0, 1, .2), limits = c(0, 1)) +
        labs(x = "Score", y = "Probability") +
        jaspGraphs::scale_JASPfill_discrete() +
        jaspGraphs::geom_rangeframe() +
        jaspGraphs::themeJaspRaw()
      
      n_points <- 2^9
      h <- 1 / (n_points + 1)
      uniform_grid <- seq(h, 1 - h, h)
      grid <- sort(c(
        qlogis(uniform_grid, dat$parameters$lt, exp(dat$parameters$log_lambda[1] - dat$parameters$log_E[1])),
        dat$parameters$free_thresholds
      ))
      
      densFun <- function(x) {
        dlogis(x, dat$parameters$lt, exp(dat$parameters$log_lambda[1] - dat$parameters$log_E[1]))
      }
      
      bounds <- c(-Inf, dat$parameters$free_thresholds, Inf)
      boundsDensity <- densFun(bounds)
      
      df_latent <- tibble(
        x = grid, y = densFun(grid),
        g = factor(findInterval(grid, bounds))
      )
      
      df_thresholds <- tibble(
        x = rep(dat$parameters$free_thresholds, 2),
        y = c(rep(0, input$nc - 1), densFun(dat$parameters$free_thresholds)),
        g = rep(1:(input$nc - 1), 2)
      )
      
      # xBreaks <- jaspGraphs::getPrettyAxisBreaks(df_latent$x)
      xBreaks <- jaspGraphs::getPrettyAxisBreaks(c(-10, 10))
      yBreaks <- jaspGraphs::getPrettyAxisBreaks(df_latent$y)
      yLimits <- range(yBreaks, -0.05 * yBreaks[length(yBreaks)])
      
      df_text <- tibble(
        x = c(dat$parameters$free_thresholds),
        # y = 1 * rep(yLimits[1L] / 2, nc - 1),
        y = rep(yLimits[1L], nc - 1),
        label = paste0("tau[", seq_len(nc - 1), "]")
      )
      
      g2 <- ggplot(data = df_latent, aes(x = x, y = y)) +
        geom_line() +
        geom_ribbon(aes(x = x, ymax = y, ymin = 0, group = g, fill = g)) +
        geom_line(data = df_thresholds, mapping = aes(x = x, y = y, group = g)) +
        geom_text(data = df_text, aes(x = x, y = y, label = label), parse = TRUE, size = 10, hjust = "center", vjust = "center") +
        scale_x_continuous(name = "Latent Truth", breaks = xBreaks, limits = range(xBreaks)) +
        scale_y_continuous(name = "Density",      breaks = yBreaks, limits = yLimits) +
        jaspGraphs::scale_JASPfill_discrete() +
        jaspGraphs::geom_rangeframe() +
        jaspGraphs::themeJaspRaw()
      
      plt_joined <- g2 / g1
      outfile <- tempfile(fileext = ".svg")
      
      # Generate the svg
      # width  <- 6
      # height <- 2*width
      height <- 5.5#3.5
      width  <- 6#height / 2
      svglite::svglite(outfile, width = width, height = height)
      print(plt_joined)
      dev.off()
      
      # Return a list containing the filename
      list(src = normalizePath(outfile),
           contentType = 'image/svg+xml',
           width       = width  * 96,
           height      = height * 96,
           alt         = "One patient")
      
    })
  }
)

```
